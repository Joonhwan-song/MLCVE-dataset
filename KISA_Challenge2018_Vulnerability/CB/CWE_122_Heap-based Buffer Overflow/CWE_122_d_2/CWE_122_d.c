//gcc -fno-stack-protector -z execstack -o ./CB ./CWE_122_d.c -m32

#include <stdio.h>
#include <stdlib.h>

char g_buf[0x30];

void read_flag(char *filename){
	FILE *fd =fopen(filename,"r");

	printf("READ........\n");	
	fread(g_buf,1,0x30,fd);

	fclose(fd);
}

void overflow(){
	char *buf = malloc(0x90);
	char *flag = malloc(0x40);

	strcpy(flag,g_buf);

	printf("Data: ");
	read(0,buf,0x100);

	printf("Data: %s\n",buf);
}

int main(void)
{
    setbuf(stdin, 0LL);
    setbuf(stdout, 0LL);
    setbuf(stderr, 0LL);

    int choice=0;
    int read_bit=0;
    char *name[128]={0,};

    printf("Select Read file\n");
    system("ls");

    read(0,name,128);

    for(;;){	
   	 printf("1. READ flagfile\n");
   	 printf("2. Heap Overflow\n");
   	 printf(">");

   	 scanf("%d",&choice);

	if(choice == 1){
		read_flag(name);
		read_bit=1;
    	}
    	else if(choice == 2){
		if(read_bit){
         		overflow();
		}
		else{
			puts("READ first.");
		}
        }
        else{
	    puts("attack fail");
	    break;
        }
    }

   return 0;
}
